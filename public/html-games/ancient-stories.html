<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Story Time Match</title>
    <style>
        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            /* Deep Blue Storybook Background */
            background: linear-gradient(to bottom, #1a237e, #4a148c);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            touch-action: none;
        }

        /* --- THE READING BAR (New!) --- */
        #narrator-bar {
            width: 90%;
            min-height: 80px;
            background: white;
            color: #333;
            border-radius: 20px;
            margin-top: 15px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 1.3rem;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border: 4px solid #FFD700;
            z-index: 10;
        }

        .highlight-word {
            color: #d32f2f; /* Red for emphasis */
            margin: 0 5px;
        }

        /* --- BOOK CONTAINER --- */
        #story-container {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            width: 100%;
            max-width: 800px;
            align-content: center;
        }

        /* --- CHARACTER CARDS --- */
        .char-card {
            width: 140px;
            height: 180px;
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            position: relative;
            transition: transform 0.3s;
        }

        .char-icon {
            font-size: 4rem;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
            cursor: pointer; /* Click to hear prompt */
        }

        .char-label {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: -10px;
            color: #FFD700;
        }

        /* The Empty Slot inside the card */
        .drop-slot {
            width: 60px;
            height: 60px;
            background: rgba(0,0,0,0.3);
            border: 2px dashed #bbb;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            transition: background 0.3s;
        }

        .char-card.completed {
            background: rgba(255, 255, 255, 0.2);
            border-color: #00E676; /* Green success border */
            transform: scale(1.05);
        }
        .char-card.completed .drop-slot {
            background: #fff;
            border-style: solid;
            border-color: #00E676;
        }

        /* --- DRAGGABLE ITEMS --- */
        #item-shelf {
            width: 100%;
            height: 120px;
            background: rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            border-radius: 30px 30px 0 0;
            position: relative;
            z-index: 20;
        }

        .item {
            width: 75px;
            height: 75px;
            background: white;
            border-radius: 50%;
            font-size: 3rem;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: grab;
            touch-action: none;
            transition: transform 0.1s;
        }

        .item:active {
            transform: scale(1.2);
            cursor: grabbing;
            z-index: 1000;
            box-shadow: 0 10px 20px rgba(255, 215, 0, 0.5);
        }

        /* --- FEEDBACK --- */
        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Win Screen */
        #win-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            visibility: hidden; opacity: 0;
            transition: opacity 0.5s;
        }
        #win-modal.visible { visibility: visible; opacity: 1; }
        
        button.restart-btn {
            padding: 15px 30px; font-size: 1.5rem;
            background: #FFD700; border: none; border-radius: 30px;
            cursor: pointer; font-weight: bold; color: #333;
            margin-top: 20px;
        }

        canvas { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:1500; }

    </style>
</head>
<body>

    <div id="narrator-bar">
        Welcome! Drag the items to tell a story.
    </div>

    <div id="story-container">
        </div>

    <div id="item-shelf">
        </div>

    <div id="win-modal">
        <div style="font-size: 5rem;">ðŸ‘‘ðŸ“šâœ¨</div>
        <h1 style="color:#FFD700;">Story Complete!</h1>
        <p style="font-size: 1.5rem; color:#ddd; text-align:center; padding:0 20px;">
            You are a master storyteller!
        </p>
    </div>

    <canvas id="confetti"></canvas>

    <script>
        // EDUCATIONAL DATA
        const storyData = [
            { 
                id: 'king', 
                name: 'King', 
                charEmoji: 'ðŸ¤´', 
                itemEmoji: 'âš”ï¸', 
                itemName: 'Sword',
                // Prompt: What the character asks for
                prompt: "I am the King. I need my sharp Sword.",
                // Success: The educational sentence explaining the connection
                success: "The King protects the castle with his Sword." 
            },
            { 
                id: 'genie', 
                name: 'Genie', 
                charEmoji: 'ðŸ§žâ€â™‚ï¸', 
                itemEmoji: 'ðŸª”', 
                itemName: 'Lamp',
                prompt: "I am the Genie. I live inside the magic Lamp.",
                success: "Poof! The Genie came out of the magic Lamp." 
            },
            { 
                id: 'mermaid', 
                name: 'Mermaid', 
                charEmoji: 'ðŸ§œâ€â™€ï¸', 
                itemEmoji: 'ðŸš', 
                itemName: 'Shell',
                prompt: "I am a Mermaid. I listen to the ocean in my Shell.",
                success: "The Mermaid listens to the ocean in her Shell." 
            },
            { 
                id: 'dragon', 
                name: 'Dragon', 
                charEmoji: 'ðŸ‰', 
                itemEmoji: 'ðŸ’Ž', 
                itemName: 'Gem',
                prompt: "I am a Dragon. I guard my shiny blue Gem.",
                success: "The Dragon went to sleep on his shiny Gem." 
            }
        ];

        let matches = 0;
        
        // Helper function to use new TTS via parent window
        function speak(text, options = {}) {
            // Try to use parent window TTS (new system)
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'html-game-tts',
                    text: text,
                    volume: options.volume || 1.0,
                    rate: options.rate || 0.9,
                    pitch: options.pitch || 1.1
                }, '*');
            } else {
                // Fallback to Web Speech API if no parent
                const synth = window.speechSynthesis;
                if(synth.speaking) synth.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.rate = options.rate || 0.9;
                u.pitch = options.pitch || 1.1;
                synth.speak(u);
            }
        }

        function initGame() {
            const container = document.getElementById('story-container');
            const shelf = document.getElementById('item-shelf');
            const modal = document.getElementById('win-modal');
            const narrator = document.getElementById('narrator-bar');

            container.innerHTML = '';
            shelf.innerHTML = '';
            modal.classList.remove('visible');
            narrator.innerHTML = "Tap a character to hear them speak!";
            stopConfetti();
            matches = 0;

            // 1. Create Characters (Zones)
            storyData.forEach(data => {
                const card = document.createElement('div');
                card.className = 'char-card';
                card.id = `card-${data.id}`;
                
                // Allow clicking character to hear prompt
                card.onclick = () => {
                    if(!card.classList.contains('completed')) {
                        updateNarrator(data.prompt, data.itemName); // Highlight the object name
                        speak(data.prompt);
                    }
                };

                card.innerHTML = `
                    <div class="char-icon">${data.charEmoji}</div>
                    <div class="char-label">${data.name}</div>
                    <div class="drop-slot" id="slot-${data.id}"></div>
                `;
                container.appendChild(card);
            });

            // 2. Create Items (Draggables)
            // Shuffle them
            const shuffledItems = [...storyData].sort(() => Math.random() - 0.5);

            shuffledItems.forEach(data => {
                const item = document.createElement('div');
                item.className = 'item';
                item.innerText = data.itemEmoji;
                item.dataset.owner = data.id;
                item.dataset.name = data.itemName;
                
                setupDrag(item);
                shelf.appendChild(item);
            });
            
            speak("Welcome to Story Time. Can you help the characters?");
        }

        // Update the top text bar with highlighted keywords
        function updateNarrator(text, highlightWord) {
            const bar = document.getElementById('narrator-bar');
            if(highlightWord) {
                // simple replace to bold the key word
                const parts = text.split(highlightWord);
                if(parts.length > 1) {
                    bar.innerHTML = parts[0] + `<span class="highlight-word">${highlightWord}</span>` + parts[1];
                } else {
                    bar.innerText = text;
                }
            } else {
                bar.innerText = text;
            }
        }

        function setupDrag(el) {
            let startX, startY;

            const start = (e) => {
                e.preventDefault();
                const t = e.touches ? e.touches[0] : e;
                startX = t.clientX;
                startY = t.clientY;
                
                // Visual Lift
                el.style.zIndex = 1000;
                
                // Speak just the word (Phonics reinforcement)
                speak(el.dataset.name);
                updateNarrator(el.dataset.name);

                const move = (e) => {
                    e.preventDefault();
                    const t = e.touches ? e.touches[0] : e;
                    const dx = t.clientX - startX;
                    const dy = t.clientY - startY;
                    el.style.transform = `translate(${dx}px, ${dy}px) scale(1.2)`;
                };

                const end = (e) => {
                    document.removeEventListener('mousemove', move);
                    document.removeEventListener('mouseup', end);
                    document.removeEventListener('touchmove', move);
                    document.removeEventListener('touchend', end);
                    checkDrop(el);
                };

                document.addEventListener('mousemove', move);
                document.addEventListener('mouseup', end);
                document.addEventListener('touchmove', move, {passive: false});
                document.addEventListener('touchend', end);
            };

            el.addEventListener('mousedown', start);
            el.addEventListener('touchstart', start, {passive: false});
        }

        function checkDrop(el) {
            const elRect = el.getBoundingClientRect();
            const elCenter = { x: elRect.left + elRect.width/2, y: elRect.top + elRect.height/2 };
            
            let targetCard = null;

            // Find which card we are over
            storyData.forEach(data => {
                const card = document.getElementById(`card-${data.id}`);
                const rect = card.getBoundingClientRect();
                if (elCenter.x >= rect.left && elCenter.x <= rect.right &&
                    elCenter.y >= rect.top && elCenter.y <= rect.bottom) {
                    targetCard = card;
                }
            });

            if (targetCard) {
                // Check ID match
                const ownerId = el.dataset.owner; // "king"
                const cardId = targetCard.id.replace('card-', ''); // "king"

                if (ownerId === cardId) {
                    handleSuccess(el, targetCard, ownerId);
                } else {
                    handleFail(el);
                }
            } else {
                // Reset if dropped in open space
                el.style.transform = `translate(0,0)`;
                el.style.zIndex = 20;
            }
        }

        function handleSuccess(item, card, id) {
            const data = storyData.find(d => d.id === id);
            
            // 1. Speak the full educational sentence
            speak(data.success);
            updateNarrator(data.success, data.itemName);

            // 2. Hide Draggable, Fill Slot
            item.style.visibility = 'hidden';
            const slot = card.querySelector('.drop-slot');
            slot.innerText = data.itemEmoji;
            
            // 3. Mark Complete
            card.classList.add('completed');

            matches++;
            if(matches === storyData.length) {
                setTimeout(winGame, 2000); // Wait for speech to finish roughly
            }
        }

        function handleFail(el) {
            speak("Try again!");
            el.style.transform = `translate(0,0)`;
            el.style.zIndex = 20;
            el.classList.add('shake');
            setTimeout(() => el.classList.remove('shake'), 500);
        }

        // speak function is now defined above in the initialization

        function winGame() {
            speak("Wonderful! You told all the stories.");
            // Hide win-modal (React component will show its own overlay)
            document.getElementById('win-modal').classList.remove('visible');
            startConfetti();
            
            // Notify parent window that game is complete
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'html-game-complete',
                    game: 'ancient-stories'
                }, '*');
            }
        }

        // --- CONFETTI ---
        let confettiInterval;
        function startConfetti() {
            const c = document.getElementById('confetti');
            const ctx = c.getContext('2d');
            c.width = window.innerWidth;
            c.height = window.innerHeight;
            let particles = [];
            for(let i=0; i<80; i++) particles.push({
                x: Math.random()*c.width, y: -20, 
                color: ['#FFD700', '#00E676', '#FFFFFF'][Math.floor(Math.random()*3)],
                size: Math.random()*8+4, speed: Math.random()*4+2
            });

            confettiInterval = setInterval(() => {
                ctx.clearRect(0,0,c.width,c.height);
                particles.forEach(p => {
                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, p.size, p.size);
                    p.y += p.speed;
                    if(p.y > c.height) p.y = -20;
                });
            }, 20);
        }
        function stopConfetti() {
            if (confettiInterval) {
                clearInterval(confettiInterval);
                confettiInterval = null;
            }
            const canvas = document.getElementById('confetti');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        window.onload = initGame;
    </script>
</body>
</html>