<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World War I - The Great War Challenge</title>
    <style>
        :root {
            --primary: #2C3E50;
            --accent: #E74C3C;
            --bg: #ECF0F1;
            --card-bg: #FFFFFF;
            --trench: #8B7355;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, var(--bg) 0%, #BDC3C7 100%);
            color: #333;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.8rem;
            margin: 10px 0;
            color: var(--primary);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .subtitle {
            font-size: 1.3rem;
            color: #666;
            font-style: italic;
        }

        /* Stage Indicator */
        #stage-indicator {
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stage-badge {
            background: linear-gradient(135deg, var(--primary), #34495E);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .score-display {
            background: #27AE60;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
        }

        /* Game Area */
        #game-area {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        /* Category Cards */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .category-card {
            background: linear-gradient(135deg, var(--card-bg), #F5F5F5);
            border: 4px solid var(--primary);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .category-card.selected {
            border-color: var(--accent);
            background: linear-gradient(135deg, #FFE5E5, #FFCCCC);
            box-shadow: 0 0 20px rgba(231,76,60,0.5);
        }

        .category-emoji {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .category-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
        }

        /* Feature Items */
        .feature-item {
            background: white;
            border: 3px solid #2C3E50;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1rem;
            text-align: center;
        }

        .feature-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border-color: var(--accent);
        }

        .feature-item.selected {
            background: #FFE5E5;
            border-color: var(--accent);
        }

        .feature-item.correct {
            background: #e8f5e9;
            border-color: #4CAF50;
        }

        .feature-item.wrong {
            background: #ffebee;
            border-color: #f44336;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Question Cards */
        .question-card {
            background: linear-gradient(135deg, var(--card-bg), #F5F5F5);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .question-text {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 25px;
            color: var(--primary);
            line-height: 1.5;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .option-btn {
            background: white;
            border: 3px solid var(--primary);
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1rem;
            text-align: center;
            font-weight: 500;
        }

        .option-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border-color: var(--accent);
        }

        .option-btn.selected {
            background: #FFE5E5;
            border-color: var(--accent);
        }

        .option-btn.correct {
            background: #e8f5e9;
            border-color: #4CAF50;
            animation: celebrate 0.5s;
        }

        .option-btn.wrong {
            background: #ffebee;
            border-color: #f44336;
        }

        @keyframes celebrate {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Timeline Visual */
        .timeline-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 30px 0;
            flex-wrap: wrap;
            gap: 20px;
        }

        .timeline-event {
            background: linear-gradient(135deg, #FFE5E5, #FFCCCC);
            border: 3px solid var(--primary);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            min-width: 180px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .timeline-event:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .timeline-event.selected {
            border-color: var(--accent);
            background: linear-gradient(135deg, #FFCCCC, #FF9999);
        }

        .timeline-year {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .timeline-event-name {
            font-size: 1rem;
            color: #666;
            line-height: 1.4;
        }

        /* Alliance Matching */
        .alliance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .country-card {
            background: white;
            border: 3px solid var(--primary);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .country-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .country-card.selected {
            border-color: var(--accent);
            background: #FFE5E5;
        }

        .alliance-zone {
            background: #F5F5F5;
            border: 3px dashed var(--primary);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            min-height: 150px;
        }

        .alliance-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
            text-align: center;
        }

        /* Effects Grid */
        .effects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .effect-card {
            background: white;
            border: 3px solid var(--primary);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .effect-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .effect-card.selected {
            border-color: var(--accent);
            background: #FFE5E5;
        }

        .effect-emoji {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .effect-text {
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* Feedback */
        .feedback {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            font-size: 1.1rem;
            display: none;
            line-height: 1.6;
        }

        .feedback.show {
            display: block;
        }

        .feedback.correct {
            background: #e8f5e9;
            border: 3px solid #4CAF50;
            color: #2E7D32;
        }

        .feedback.wrong {
            background: #ffebee;
            border: 3px solid #f44336;
            color: #c62828;
        }

        /* Buttons */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            margin: 10px;
        }

        .btn:hover {
            background: #34495E;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-container {
            text-align: center;
            margin-top: 30px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-content h2 {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .modal-content p {
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27AE60, #2ECC71);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Complex Analysis Section */
        .analysis-section {
            background: #F8F9FA;
            border: 2px solid var(--primary);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .analysis-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåç World War I - The Great War Challenge üåç</h1>
            <p class="subtitle">A comprehensive analysis of the war that changed the world forever</p>
        </header>

        <div id="stage-indicator">
            <div class="stage-badge" id="stage-badge">Stage 1 of 6</div>
            <div class="score-display">Score: <span id="score">0</span></div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%">0%</div>
            </div>
        </div>

        <div id="game-area">
            <!-- Game content will be dynamically inserted here -->
        </div>
    </div>

    <div id="completion-modal" class="modal">
        <div class="modal-content">
            <h2>üéâ Congratulations! üéâ</h2>
            <p id="completion-message"></p>
            <button class="btn" onclick="closeModal()">Continue</button>
        </div>
    </div>

    <script>
        // Game Data - Advanced for Year 6
        const categories = {
            causes: {
                name: 'Causes of WWI (M.A.I.N.)',
                emoji: '‚öîÔ∏è',
                features: [
                    { text: 'Militarism - Countries built up huge armies and weapons', correct: true },
                    { text: 'Alliances - Countries formed promises to help each other', correct: true },
                    { text: 'Imperialism - Countries competed for colonies and territories', correct: true },
                    { text: 'Nationalism - Extreme pride in one\'s country', correct: true },
                    { text: 'Assassination of Archduke Franz Ferdinand (June 28, 1914)', correct: true },
                    { text: 'A simple disagreement between two countries', correct: false },
                    { text: 'Only happened because of one person', correct: false }
                ]
            },
            alliances: {
                name: 'Alliances and Countries',
                emoji: 'ü§ù',
                features: [
                    { text: 'Triple Entente: France, Russia, Britain (later joined by US)', correct: true },
                    { text: 'Triple Alliance: Germany, Austria-Hungary, Italy (Italy later switched)', correct: true },
                    { text: 'Central Powers: Germany, Austria-Hungary, Ottoman Empire', correct: true },
                    { text: 'Allied Powers: Britain, France, Russia, US, and others', correct: true },
                    { text: 'US joined in 1917 after staying neutral', correct: true },
                    { text: 'All countries were on the same side', correct: false },
                    { text: 'Only two countries fought', correct: false }
                ]
            },
            trenches: {
                name: 'Trench Warfare',
                emoji: 'üï≥Ô∏è',
                features: [
                    { text: 'Trenches stretched from Belgium to Switzerland', correct: true },
                    { text: 'Three lines: front-line, support, and reserve trenches', correct: true },
                    { text: 'No-man\'s land - dangerous area between enemy trenches', correct: true },
                    { text: 'Trench foot, trench fever, and shell shock were common', correct: true },
                    { text: 'Muddy, waterlogged, with rats and lice', correct: true },
                    { text: 'Comfortable and safe living conditions', correct: false },
                    { text: 'Soldiers only stayed in trenches for a few days', correct: false }
                ]
            },
            weapons: {
                name: 'New Weapons',
                emoji: 'üî´',
                features: [
                    { text: 'Machine guns - could fire hundreds of bullets per minute', correct: true },
                    { text: 'Tanks - first used in 1916 at the Battle of the Somme', correct: true },
                    { text: 'Poison gas - chlorine and mustard gas', correct: true },
                    { text: 'Airplanes - used for reconnaissance and bombing', correct: true },
                    { text: 'Submarines (U-boats) - used by Germany', correct: true },
                    { text: 'Only swords and spears were used', correct: false },
                    { text: 'No new technology was developed', correct: false }
                ]
            },
            battles: {
                name: 'Major Battles',
                emoji: 'üéØ',
                features: [
                    { text: 'Battle of the Somme (1916) - over 1 million casualties', correct: true },
                    { text: 'Battle of Verdun (1916) - longest battle, 10 months', correct: true },
                    { text: 'Battle of Ypres - first use of poison gas', correct: true },
                    { text: 'Battle of the Marne (1914) - stopped German advance', correct: true },
                    { text: 'Gallipoli Campaign (1915) - failed Allied invasion', correct: true },
                    { text: 'Only one battle was fought', correct: false },
                    { text: 'All battles were short and easy', correct: false }
                ]
            },
            effects: {
                name: 'Effects and End',
                emoji: 'üìú',
                features: [
                    { text: 'War ended November 11, 1918 (Armistice Day)', correct: true },
                    { text: 'Treaty of Versailles (1919) - blamed Germany', correct: true },
                    { text: 'Over 20 million people died (soldiers and civilians)', correct: true },
                    { text: 'Led to collapse of empires (Austria-Hungary, Ottoman, Russian)', correct: true },
                    { text: 'Created conditions that led to World War II', correct: true },
                    { text: 'Nothing changed after the war', correct: false },
                    { text: 'Everyone was happy with the peace treaty', correct: false }
                ]
            }
        };

        const advancedQuestions = [
            {
                question: "What does M.A.I.N. stand for in the causes of World War I?",
                options: ["Money, Arms, Industry, Nations", "Militarism, Alliances, Imperialism, Nationalism", "Men, Airplanes, Infantry, Navy", "March, April, May, June"],
                correct: 1,
                explanation: "M.A.I.N. stands for Militarism (building up armies), Alliances (countries promising to help each other), Imperialism (competing for colonies), and Nationalism (extreme pride in one's country). These four factors created the conditions for war!"
            },
            {
                question: "What was the 'spark' that started World War I?",
                options: ["A trade dispute", "The assassination of Archduke Franz Ferdinand on June 28, 1914", "A border dispute", "A naval battle"],
                correct: 1,
                explanation: "The assassination of Archduke Franz Ferdinand of Austria-Hungary by Gavrilo Princip in Sarajevo on June 28, 1914, was the immediate spark that set off a chain reaction of countries declaring war on each other!"
            },
            {
                question: "What was 'no-man's land'?",
                options: ["A safe area behind the trenches", "The dangerous area between enemy trenches, exposed to gunfire and artillery", "A peaceful zone where soldiers met", "The name of a country"],
                correct: 1,
                explanation: "No-man's land was the dangerous area between opposing trenches. It was exposed to gunfire, artillery, and barbed wire. Soldiers had to cross this deadly space during attacks!"
            },
            {
                question: "What was 'trench foot'?",
                options: ["A type of boot", "A serious condition caused by feet staying wet too long in trenches, leading to infection", "A way of walking", "A type of weapon"],
                correct: 1,
                explanation: "Trench foot was a serious medical condition caused by feet staying wet and cold in the muddy trenches for too long. It could lead to infection, gangrene, and sometimes amputation!"
            },
            {
                question: "When did the United States join World War I?",
                options: ["1914", "1915", "1917", "1918"],
                correct: 2,
                explanation: "The United States joined World War I in 1917, after staying neutral for three years. The sinking of the Lusitania and other factors finally brought the US into the war!"
            },
            {
                question: "What was 'shell shock'?",
                options: ["A type of weapon", "A psychological condition (now called PTSD) caused by constant fear, explosions, and seeing friends die", "A type of gas", "A battle strategy"],
                correct: 1,
                explanation: "Shell shock was a psychological condition suffered by many soldiers. It was caused by the constant fear, noise of explosions, and trauma of seeing friends hurt or die. Today we call it Post-Traumatic Stress Disorder (PTSD)!"
            },
            {
                question: "Which battle was the longest of World War I?",
                options: ["Battle of the Somme", "Battle of Verdun (10 months)", "Battle of Ypres", "Battle of the Marne"],
                correct: 1,
                explanation: "The Battle of Verdun lasted 10 months (February to December 1916) and was the longest battle of World War I. It was one of the bloodiest battles in history!"
            },
            {
                question: "What was the Treaty of Versailles?",
                options: ["A trade agreement", "The peace treaty signed in 1919 that ended WWI and blamed Germany", "A military alliance", "A type of weapon"],
                correct: 1,
                explanation: "The Treaty of Versailles was the peace treaty signed in 1919 that officially ended World War I. It placed harsh penalties on Germany, including taking away territory and making them pay reparations. Many historians believe this helped cause World War II!"
            },
            {
                question: "How many people died in World War I?",
                options: ["1 million", "5 million", "Over 20 million (soldiers and civilians)", "50 million"],
                correct: 2,
                explanation: "Over 20 million people died in World War I, including both soldiers and civilians. This was one of the deadliest conflicts in human history up to that point!"
            },
            {
                question: "What happened to empires after World War I?",
                options: ["They all got stronger", "Several empires collapsed: Austria-Hungary, Ottoman Empire, and Russian Empire", "Nothing changed", "They all merged together"],
                correct: 1,
                explanation: "World War I led to the collapse of several major empires: the Austro-Hungarian Empire, the Ottoman Empire, and the Russian Empire. New countries were created from their territories!"
            }
        ];

        const timelineEvents = [
            { year: '1914', event: 'Archduke Franz Ferdinand assassinated; WWI begins', order: 1 },
            { year: '1915', event: 'Gallipoli Campaign; Italy joins Allies', order: 2 },
            { year: '1916', event: 'Battles of Verdun and the Somme', order: 3 },
            { year: '1917', event: 'US enters war; Russia exits (Revolution)', order: 4 },
            { year: '1918', event: 'War ends November 11 (Armistice Day)', order: 5 },
            { year: '1919', event: 'Treaty of Versailles signed', order: 6 }
        ];

        const countries = {
            allied: ['Britain', 'France', 'Russia', 'United States', 'Italy (from 1915)', 'Serbia', 'Belgium'],
            central: ['Germany', 'Austria-Hungary', 'Ottoman Empire', 'Bulgaria']
        };

        const effects = [
            { effect: 'Over 20 million people died', correct: true, emoji: 'üíî' },
            { effect: 'Empires collapsed (Austria-Hungary, Ottoman, Russian)', correct: true, emoji: 'üèõÔ∏è' },
            { effect: 'New countries were created', correct: true, emoji: 'üó∫Ô∏è' },
            { effect: 'Treaty of Versailles blamed Germany', correct: true, emoji: 'üìú' },
            { effect: 'Created conditions leading to World War II', correct: true, emoji: '‚öîÔ∏è' },
            { effect: 'Nothing changed after the war', correct: false, emoji: '‚ùå' },
            { effect: 'Everyone was happy with the peace', correct: false, emoji: 'üòä' },
            { effect: 'No empires fell', correct: false, emoji: 'üëë' }
        ];

        // Game State
        let currentStage = 1;
        let score = 0;
        let totalQuestions = 0;
        let correctAnswers = 0;
        let selectedCategory = null;
        let selectedFeatures = new Set();
        let selectedTimelineOrder = [];
        let selectedCountries = { allied: [], central: [] };
        let selectedEffects = new Set();

        // Initialize Game
        function initGame() {
            currentStage = 1;
            score = 0;
            totalQuestions = 0;
            correctAnswers = 0;
            updateScore();
            loadStage(1);
        }

        function loadStage(stage) {
            currentStage = stage;
            const gameArea = document.getElementById('game-area');
            gameArea.innerHTML = '';

            updateStageIndicator();

            switch(stage) {
                case 1:
                    loadStage1();
                    break;
                case 2:
                    loadStage2();
                    break;
                case 3:
                    loadStage3();
                    break;
                case 4:
                    loadStage4();
                    break;
                case 5:
                    loadStage5();
                    break;
                case 6:
                    loadStage6();
                    break;
            }
        }

        function loadStage1() {
            const gameArea = document.getElementById('game-area');
            
            let html = '<h2 style="text-align: center; margin-bottom: 30px; font-size: 1.8rem; color: var(--primary);">Stage 1: Match Features to Categories</h2>';
            html += '<p style="text-align: center; margin-bottom: 20px; font-size: 1.2rem;">Select a category, then click on ALL the features that belong to it!</p>';
            
            html += '<div class="category-grid">';
            Object.keys(categories).forEach(key => {
                const cat = categories[key];
                html += `
                    <div class="category-card" data-category="${key}" onclick="selectCategory('${key}')">
                        <div class="category-emoji">${cat.emoji}</div>
                        <div class="category-name">${cat.name}</div>
                    </div>
                `;
            });
            html += '</div>';
            
            html += '<div id="features-section" style="display: none;">';
            html += '<h3 style="text-align: center; margin: 30px 0 20px 0; font-size: 1.4rem;">Click on ALL the features that belong to this category:</h3>';
            html += '<div id="features-container"></div>';
            html += '<div class="btn-container">';
            html += '<button class="btn" onclick="checkStage1()">Check Answers</button>';
            html += '</div>';
            html += '</div>';
            
            html += '<div id="feedback" class="feedback"></div>';
            
            gameArea.innerHTML = html;
            selectedFeatures.clear();
        }

        function selectCategory(categoryKey) {
            selectedCategory = categoryKey;
            const cards = document.querySelectorAll('.category-card');
            cards.forEach(card => card.classList.remove('selected'));
            document.querySelector(`[data-category="${categoryKey}"]`).classList.add('selected');
            
            const featuresSection = document.getElementById('features-section');
            const featuresContainer = document.getElementById('features-container');
            
            // Get all features and shuffle
            const allFeatures = [];
            Object.keys(categories).forEach(key => {
                categories[key].features.forEach(feature => {
                    allFeatures.push({ text: feature.text, correct: key === categoryKey && feature.correct, category: key });
                });
            });
            
            const shuffled = allFeatures.sort(() => Math.random() - 0.5);
            
            featuresContainer.innerHTML = '';
            shuffled.forEach((feature, index) => {
                const featureCard = document.createElement('div');
                featureCard.className = 'feature-item';
                featureCard.textContent = feature.text;
                featureCard.dataset.index = index;
                featureCard.dataset.correct = feature.correct;
                featureCard.onclick = () => toggleFeature(index);
                featuresContainer.appendChild(featureCard);
            });
            
            featuresSection.style.display = 'block';
        }

        function toggleFeature(index) {
            const card = document.querySelector(`[data-index="${index}"]`);
            if (card.classList.contains('selected')) {
                card.classList.remove('selected');
                selectedFeatures.delete(index);
            } else {
                card.classList.add('selected');
                selectedFeatures.add(index);
            }
        }

        function checkStage1() {
            const cards = document.querySelectorAll('.feature-item');
            let correct = 0;
            let totalCorrect = categories[selectedCategory].features.filter(f => f.correct).length;
            
            cards.forEach(card => {
                const isCorrect = card.dataset.correct === 'true';
                const isSelected = card.classList.contains('selected');
                
                if (isCorrect && isSelected) {
                    correct++;
                    card.classList.add('correct');
                } else if (isCorrect && !isSelected) {
                    card.classList.add('correct');
                } else if (!isCorrect && isSelected) {
                    card.classList.add('wrong');
                }
            });
            
            const feedback = document.getElementById('feedback');
            if (correct === totalCorrect && selectedFeatures.size === totalCorrect) {
                feedback.textContent = `‚úì Perfect! You found all ${totalCorrect} correct features for ${categories[selectedCategory].name}!`;
                feedback.className = 'feedback show correct';
                score += 35;
                correctAnswers += totalCorrect;
            } else {
                feedback.textContent = `You found ${correct} out of ${totalCorrect} correct features. Keep trying!`;
                feedback.className = 'feedback show wrong';
                correctAnswers += correct;
            }
            
            totalQuestions += cards.length;
            updateScore();
            
            setTimeout(() => {
                if (currentStage < 6) {
                    loadStage(currentStage + 1);
                } else {
                    endGame();
                }
            }, 3000);
            
            // Send TTS
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'html-game-tts',
                    text: feedback.textContent,
                    rate: 0.85,
                    pitch: 1.0
                }, '*');
            }
        }

        function loadStage2() {
            const gameArea = document.getElementById('game-area');
            const question = advancedQuestions[Math.floor(Math.random() * advancedQuestions.length)];
            
            let html = '<h2 style="text-align: center; margin-bottom: 30px; font-size: 1.8rem; color: var(--primary);">Stage 2: Advanced Knowledge Challenge</h2>';
            html += '<div class="question-card">';
            html += `<div class="question-text">${question.question}</div>`;
            html += '<div class="options-grid">';
            
            question.options.forEach((option, index) => {
                html += `<button class="option-btn" data-index="${index}" onclick="selectOption(${index}, ${question.correct}, '${question.explanation.replace(/'/g, "\\'")}')">${option}</button>`;
            });
            
            html += '</div></div>';
            html += '<div id="feedback" class="feedback"></div>';
            html += '<div class="btn-container">';
            html += '<button class="btn" id="next-stage2" onclick="nextStage2()" style="display: none;">Continue</button>';
            html += '</div>';
            
            gameArea.innerHTML = html;
        }

        function selectOption(selectedIndex, correctIndex, explanation) {
            const buttons = document.querySelectorAll('.option-btn');
            const feedback = document.getElementById('feedback');
            
            buttons.forEach(btn => btn.disabled = true);
            
            if (selectedIndex === correctIndex) {
                buttons[selectedIndex].classList.add('correct');
                feedback.textContent = '‚úì Correct! ' + explanation;
                feedback.className = 'feedback show correct';
                score += 25;
                correctAnswers++;
            } else {
                buttons[selectedIndex].classList.add('wrong');
                buttons[correctIndex].classList.add('correct');
                feedback.textContent = '‚úó Not quite. ' + explanation;
                feedback.className = 'feedback show wrong';
            }
            
            totalQuestions++;
            updateScore();
            
            document.getElementById('next-stage2').style.display = 'inline-block';
            
            // Send TTS
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'html-game-tts',
                    text: feedback.textContent,
                    rate: 0.85,
                    pitch: 1.0
                }, '*');
            }
        }

        function nextStage2() {
            if (currentStage < 6) {
                loadStage(currentStage + 1);
            } else {
                endGame();
            }
        }

        function loadStage3() {
            const gameArea = document.getElementById('game-area');
            
            let html = '<h2 style="text-align: center; margin-bottom: 30px; font-size: 1.8rem; color: var(--primary);">Stage 3: WWI Timeline</h2>';
            html += '<p style="text-align: center; margin-bottom: 20px; font-size: 1.2rem;">Put these critical events in the correct chronological order!</p>';
            
            const shuffledEvents = [...timelineEvents].sort(() => Math.random() - 0.5);
            
            html += '<div class="timeline-container">';
            shuffledEvents.forEach((event, index) => {
                html += `
                    <div class="timeline-event" data-year="${event.year}" data-order="${event.order}" onclick="selectTimelineEvent('${event.year}', ${event.order})">
                        <div class="timeline-year">${event.year}</div>
                        <div class="timeline-event-name">${event.event}</div>
                    </div>
                `;
            });
            html += '</div>';
            
            html += '<div id="selected-timeline" style="margin-top: 30px; min-height: 60px; padding: 15px; background: #F5E6D3; border-radius: 10px; border: 2px dashed var(--primary); text-align: center;"></div>';
            
            html += '<div id="feedback" class="feedback"></div>';
            html += '<div class="btn-container">';
            html += '<button class="btn" onclick="checkStage3()">Check Order</button>';
            html += '</div>';
            
            gameArea.innerHTML = html;
            selectedTimelineOrder = [];
        }

        function selectTimelineEvent(year, order) {
            const event = document.querySelector(`[data-year="${year}"]`);
            const existingIndex = selectedTimelineOrder.findIndex(e => e.year === year);
            
            if (existingIndex !== -1) {
                selectedTimelineOrder.splice(existingIndex, 1);
                event.classList.remove('selected');
            } else {
                selectedTimelineOrder.push({ year, order });
                event.classList.add('selected');
            }
            
            updateTimelineDisplay();
        }

        function updateTimelineDisplay() {
            const display = document.getElementById('selected-timeline');
            if (selectedTimelineOrder.length === 0) {
                display.innerHTML = '<p style="color: #666; font-style: italic;">Click events in chronological order...</p>';
            } else {
                display.innerHTML = selectedTimelineOrder.map((e, i) => 
                    `${i + 1}. ${e.year}`
                ).join(' ‚Üí ');
            }
        }

        function checkStage3() {
            const correctOrder = [1, 2, 3, 4, 5, 6];
            const selectedOrder = selectedTimelineOrder.map(e => e.order);
            const isCorrect = JSON.stringify(selectedOrder) === JSON.stringify(correctOrder);
            
            const feedback = document.getElementById('feedback');
            if (isCorrect && selectedTimelineOrder.length === 6) {
                feedback.textContent = '‚úì Perfect! The correct order is: 1914 (War begins) ‚Üí 1915 (Gallipoli) ‚Üí 1916 (Verdun & Somme) ‚Üí 1917 (US enters) ‚Üí 1918 (War ends) ‚Üí 1919 (Treaty)!';
                feedback.className = 'feedback show correct';
                score += 40;
                correctAnswers += 6;
            } else {
                feedback.textContent = 'Not quite. The correct order is: 1914 ‚Üí 1915 ‚Üí 1916 ‚Üí 1917 ‚Üí 1918 ‚Üí 1919. Try again!';
                feedback.className = 'feedback show wrong';
            }
            
            totalQuestions += 6;
            updateScore();
            
            setTimeout(() => {
                if (currentStage < 6) {
                    loadStage(currentStage + 1);
                } else {
                    endGame();
                }
            }, 3000);
            
            // Send TTS
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'html-game-tts',
                    text: feedback.textContent,
                    rate: 0.85,
                    pitch: 1.0
                }, '*');
            }
        }

        function loadStage4() {
            const gameArea = document.getElementById('game-area');
            
            let html = '<h2 style="text-align: center; margin-bottom: 30px; font-size: 1.8rem; color: var(--primary);">Stage 4: Match Countries to Alliances</h2>';
            html += '<p style="text-align: center; margin-bottom: 20px; font-size: 1.2rem;">Drag countries to their correct alliance side!</p>';
            
            const allCountries = [...countries.allied, ...countries.central].sort(() => Math.random() - 0.5);
            
            html += '<div class="alliance-grid">';
            allCountries.forEach((country, index) => {
                html += `
                    <div class="country-card" data-country="${country}" data-index="${index}" onclick="selectCountry('${country}', ${index})">
                        ${country}
                    </div>
                `;
            });
            html += '</div>';
            
            html += '<div class="alliance-zone">';
            html += '<div class="alliance-title">Allied Powers</div>';
            html += '<div id="allied-zone" style="min-height: 100px; padding: 10px;"></div>';
            html += '</div>';
            
            html += '<div class="alliance-zone">';
            html += '<div class="alliance-title">Central Powers</div>';
            html += '<div id="central-zone" style="min-height: 100px; padding: 10px;"></div>';
            html += '</div>';
            
            html += '<div id="feedback" class="feedback"></div>';
            html += '<div class="btn-container">';
            html += '<button class="btn" onclick="checkStage4()">Check Alliances</button>';
            html += '</div>';
            
            gameArea.innerHTML = html;
            selectedCountries = { allied: [], central: [] };
        }

        function selectCountry(country, index) {
            const card = document.querySelector(`[data-index="${index}"]`);
            const isAllied = countries.allied.includes(country);
            const isCentral = countries.central.includes(country);
            
            // Remove from both zones first
            const alliedZone = document.getElementById('allied-zone');
            const centralZone = document.getElementById('central-zone');
            
            if (card.parentElement === alliedZone) {
                alliedZone.removeChild(card);
                selectedCountries.allied = selectedCountries.allied.filter(c => c !== country);
            } else if (card.parentElement === centralZone) {
                centralZone.removeChild(card);
                selectedCountries.central = selectedCountries.central.filter(c => c !== country);
            } else {
                // Add to correct zone
                if (isAllied) {
                    alliedZone.appendChild(card);
                    if (!selectedCountries.allied.includes(country)) {
                        selectedCountries.allied.push(country);
                    }
                } else if (isCentral) {
                    centralZone.appendChild(card);
                    if (!selectedCountries.central.includes(country)) {
                        selectedCountries.central.push(country);
                    }
                }
            }
        }

        function checkStage4() {
            const allAlliedCorrect = countries.allied.every(c => selectedCountries.allied.includes(c));
            const allCentralCorrect = countries.central.every(c => selectedCountries.central.includes(c));
            const noWrongAllied = selectedCountries.allied.every(c => countries.allied.includes(c));
            const noWrongCentral = selectedCountries.central.every(c => countries.central.includes(c));
            
            const isCorrect = allAlliedCorrect && allCentralCorrect && noWrongAllied && noWrongCentral;
            
            const feedback = document.getElementById('feedback');
            if (isCorrect && selectedCountries.allied.length === countries.allied.length && selectedCountries.central.length === countries.central.length) {
                feedback.textContent = '‚úì Perfect! You correctly identified all Allied Powers (Britain, France, Russia, US, Italy, Serbia, Belgium) and Central Powers (Germany, Austria-Hungary, Ottoman Empire, Bulgaria)!';
                feedback.className = 'feedback show correct';
                score += 40;
                correctAnswers += (countries.allied.length + countries.central.length);
            } else {
                feedback.textContent = 'Not quite. Remember: Allied Powers included Britain, France, Russia, US, Italy, Serbia, and Belgium. Central Powers were Germany, Austria-Hungary, Ottoman Empire, and Bulgaria. Try again!';
                feedback.className = 'feedback show wrong';
            }
            
            totalQuestions += (countries.allied.length + countries.central.length);
            updateScore();
            
            setTimeout(() => {
                if (currentStage < 6) {
                    loadStage(currentStage + 1);
                } else {
                    endGame();
                }
            }, 3000);
            
            // Send TTS
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'html-game-tts',
                    text: feedback.textContent,
                    rate: 0.85,
                    pitch: 1.0
                }, '*');
            }
        }

        function loadStage5() {
            const gameArea = document.getElementById('game-area');
            
            let html = '<h2 style="text-align: center; margin-bottom: 30px; font-size: 1.8rem; color: var(--primary);">Stage 5: Effects of World War I</h2>';
            html += '<p style="text-align: center; margin-bottom: 20px; font-size: 1.2rem;">Select ALL the real effects and consequences of World War I!</p>';
            
            const shuffledEffects = effects.sort(() => Math.random() - 0.5);
            
            html += '<div class="effects-grid">';
            shuffledEffects.forEach((effect, index) => {
                html += `
                    <div class="effect-card" data-index="${index}" data-correct="${effect.correct}" onclick="toggleEffect(${index}, ${effect.correct})">
                        <div class="effect-emoji">${effect.emoji}</div>
                        <div class="effect-text">${effect.effect}</div>
                    </div>
                `;
            });
            html += '</div>';
            
            html += '<div id="feedback" class="feedback"></div>';
            html += '<div class="btn-container">';
            html += '<button class="btn" onclick="checkStage5()">Check Answers</button>';
            html += '</div>';
            
            gameArea.innerHTML = html;
            selectedEffects.clear();
        }

        function toggleEffect(index, isCorrect) {
            const card = document.querySelector(`[data-index="${index}"]`);
            if (card.classList.contains('selected')) {
                card.classList.remove('selected');
                selectedEffects.delete(index);
            } else {
                card.classList.add('selected');
                selectedEffects.add(index);
            }
        }

        function checkStage5() {
            const cards = document.querySelectorAll('.effect-card');
            let correct = 0;
            let totalCorrect = 5; // 5 correct effects
            
            cards.forEach(card => {
                const isCorrect = card.dataset.correct === 'true';
                const isSelected = card.classList.contains('selected');
                
                if (isCorrect && isSelected) {
                    correct++;
                    card.style.borderColor = '#4CAF50';
                    card.style.background = '#e8f5e9';
                } else if (isCorrect && !isSelected) {
                    card.style.borderColor = '#4CAF50';
                    card.style.background = '#e8f5e9';
                } else if (!isCorrect && isSelected) {
                    card.style.borderColor = '#f44336';
                    card.style.background = '#ffebee';
                }
            });
            
            const feedback = document.getElementById('feedback');
            if (correct === totalCorrect && selectedEffects.size === totalCorrect) {
                feedback.textContent = `‚úì Perfect! You found all ${totalCorrect} correct effects! World War I had devastating consequences: over 20 million deaths, empires collapsed, new countries were created, the Treaty of Versailles blamed Germany, and it created conditions that led to World War II!`;
                feedback.className = 'feedback show correct';
                score += 35;
                correctAnswers += totalCorrect;
            } else {
                feedback.textContent = `You found ${correct} out of ${totalCorrect} correct effects. Remember: WWI caused over 20 million deaths, empires collapsed, new countries were created, the Treaty of Versailles blamed Germany, and it led to conditions causing WWII!`;
                feedback.className = 'feedback show wrong';
                correctAnswers += correct;
            }
            
            totalQuestions += cards.length;
            updateScore();
            
            setTimeout(() => {
                if (currentStage < 6) {
                    loadStage(currentStage + 1);
                } else {
                    endGame();
                }
            }, 3000);
            
            // Send TTS
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'html-game-tts',
                    text: feedback.textContent,
                    rate: 0.85,
                    pitch: 1.0
                }, '*');
            }
        }

        function loadStage6() {
            const gameArea = document.getElementById('game-area');
            const question = advancedQuestions[Math.floor(Math.random() * advancedQuestions.length)];
            
            let html = '<h2 style="text-align: center; margin-bottom: 30px; font-size: 1.8rem; color: var(--primary);">Stage 6: Final Challenge</h2>';
            html += '<p style="text-align: center; margin-bottom: 20px; font-size: 1.2rem; color: #666;">One final advanced question to test your deep understanding!</p>';
            html += '<div class="question-card">';
            html += `<div class="question-text">${question.question}</div>`;
            html += '<div class="options-grid">';
            
            question.options.forEach((option, index) => {
                html += `<button class="option-btn" data-index="${index}" onclick="selectOption(${index}, ${question.correct}, '${question.explanation.replace(/'/g, "\\'")}')">${option}</button>`;
            });
            
            html += '</div></div>';
            html += '<div id="feedback" class="feedback"></div>';
            html += '<div class="btn-container">';
            html += '<button class="btn" id="next-stage6" onclick="endGame()" style="display: none;">Finish Game</button>';
            html += '</div>';
            
            gameArea.innerHTML = html;
        }

        function updateStageIndicator() {
            document.getElementById('stage-badge').textContent = `Stage ${currentStage} of 6`;
            const progress = (currentStage / 6) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('progress-fill').textContent = Math.round(progress) + '%';
        }

        function updateScore() {
            document.getElementById('score').textContent = score;
        }

        function endGame() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            let message = '';
            
            if (percentage >= 90) {
                message = `Outstanding! You scored ${score} points with ${percentage}% correct! You're a true expert on World War I! üèÜ`;
            } else if (percentage >= 75) {
                message = `Excellent! You scored ${score} points with ${percentage}% correct! You have a strong understanding of this complex period in history! üåü`;
            } else if (percentage >= 60) {
                message = `Good work! You scored ${score} points with ${percentage}% correct! Keep studying to deepen your understanding! üìö`;
            } else {
                message = `You scored ${score} points with ${percentage}% correct. Review the lesson and try again! This is complex history - keep learning! üí™`;
            }
            
            document.getElementById('completion-message').textContent = message;
            document.getElementById('completion-modal').classList.add('show');
            
            // Send completion message
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'html-game-tts',
                    text: message,
                    rate: 0.9,
                    pitch: 1.0
                }, '*');
                
                setTimeout(() => {
                    window.parent.postMessage({
                        type: 'html-game-complete',
                        game: 'world-war-i'
                    }, '*');
                }, 3000);
            }
        }

        function closeModal() {
            document.getElementById('completion-modal').classList.remove('show');
        }

        // Initialize on load
        window.onload = initGame;
    </script>
</body>
</html>
